FROM intel/deep-learning-essentials:2025.1.3-0-devel-ubuntu24.04

ENV DEBIAN_FRONTEND=noninteractive
ARG BUILD_ENV=docker
ENV BUILD_ENV=${BUILD_ENV}

# Install all dependencies required to run the installer
RUN set -eux; \
    # Remove conflicting packages if they exist
    apt-get remove -y libze-intel-gpu1 libigc1 libigdfcl1 libze-dev || true; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
        systemd \
        pciutils \
        iproute2 \
        net-tools \
        sudo \
        vim \
        curl \
        wget \
        bash-completion \
        locales \
        dbus \
        libdrm2 \
        libpciaccess0 \
        libx11-6 \
        libxml2 \
        libnl-3-200 \
        libnl-route-3-200 \
        libnuma1 \
        libxext6 \
        xz-utils \
&& apt-get clean && rm -rf /var/lib/apt/lists/*; \
        \
        # Prepare multi-arc directory
        mkdir -p /opt/intel/multi-arc; \
        cd /tmp; \
    \
    # Download offline installer (ensure it's a direct tar.xz)
    wget -O multi-arc-bmg-offline-installer.tar.xz "https://sourceforge.net/projects/analytics-zoo/files/vllm-scaler/offline-installer/bmg/multi-arc-bmg-offline-installer-25.38.4.1.tar.xz/download"; \
    \
    mv multi-arc-bmg-offline-installer.tar.xz /opt/intel/multi-arc/; \
    cd /opt/intel/multi-arc; \
    \
    # Extract and run installer
    tar -xf multi-arc-bmg-offline-installer.tar.xz; \
    cd multi-arc-bmg-offline-installer-*; \
    chmod +x installer.sh; \
    ./installer.sh; \
    \
    # Cleanup
    cd /opt/intel/multi-arc; \
    rm -rf multi-arc-bmg-offline-installer.tar.xz; \
    rm -rf multi-arc-bmg-offline-installer-*/*.sh multi-arc-bmg-offline-installer-*/oneapi multi-arc-bmg-offline-installer-*/kernel multi-arc-bmg-offline-installer-*/firmware

# Set up UTF-8 locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8

# Optional systemd support
# Note: requires --privileged and cgroup mount if enabled
STOPSIGNAL SIGRTMIN+3
CMD ["/lib/systemd/systemd"]
