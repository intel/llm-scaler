FROM scratch AS src

ADD --unpack=true multi-arc-*.tar.xz /

FROM intel/deep-learning-essentials:2025.2.2-0-devel-ubuntu24.04

ENV DEBIAN_FRONTEND=noninteractive
ARG BUILD_ENV=docker
ENV BUILD_ENV=${BUILD_ENV}

# Install all dependencies required to run the installer
RUN set -eux; \
    # Remove conflicting packages if they exist
    apt-get remove -y libze-intel-gpu1 libigc1 libigdfcl1 libze-dev || true; \
    apt-get update; \
    apt-get install -y --no-install-recommends \
        systemd \
        pciutils \
        iproute2 \
        net-tools \
        sudo \
        vim \
        curl \
        wget \
        bash-completion \
        locales \
        dbus \
        libdrm2 \
        libpciaccess0 \
        libx11-6 \
        libxml2 \
        libnl-3-200 \
        libnl-route-3-200 \
        libnuma1 \
        libxext6 \
        xz-utils \
&& apt-get clean && rm -rf /var/lib/apt/lists/*;

RUN --mount=from=src,rw,target=/src <<EOF
    SRC_DIR=$(ls -d /src/multi-arc-*)
    DST_DIR=/opt/intel/multi-arc

    cd "$SRC_DIR" && ./installer.sh

    install -d "$DST_DIR"
    for item in scripts tools results; do
        cp -rf "$SRC_DIR/$item" "$DST_DIR/"
    done

    cp "$SRC_DIR/README.md" "$SRC_DIR/VERSION" "$DST_DIR/"
EOF

# Set up UTF-8 locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8 LANGUAGE=en_US:en LC_ALL=en_US.UTF-8

# Optional systemd support
# Note: requires --privileged and cgroup mount if enabled
STOPSIGNAL SIGRTMIN+3
CMD ["/lib/systemd/systemd"]
